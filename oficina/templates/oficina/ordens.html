{% extends 'oficina/base.html' %}

{% block title %}Ordens de Serviço - MecanoSync{% endblock %}

{% block content %}
<div class="page active" id="ordens">
    <div class="page-header">
        <h1>Ordens de Serviço</h1>
        <a href="{% url 'ordem_criar' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Nova Ordem
        </a>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="table-controls">
                <form method="get" class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" name="busca" placeholder="Buscar ordem..." value="{{ request.GET.busca }}">
                </form>
                <form method="get">
                    <select class="filter-select" name="filtro" onchange="this.form.submit()">
                        <option value="todas" {% if request.GET.filtro == 'todas' %}selected{% endif %}>Todas</option>
                        <option value="em_andamento" {% if request.GET.filtro == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                        <option value="aguardando_pecas" {% if request.GET.filtro == 'aguardando_pecas' %}selected{% endif %}>Aguardando Peças</option>
                        <option value="concluida" {% if request.GET.filtro == 'concluida' %}selected{% endif %}>Concluídas</option>
                    </select>
                </form>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>OS</th>
                        <th>Cliente</th>
                        <th>Veículo</th>
                        <th>Serviço</th>
                        <th>Data Entrada</th>
                        <th>Previsão</th>
                        <th>Status</th>
                        <th>Valor</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ordem in ordens %}
                    <tr>
                        <td>#{{ ordem.numero_os }}</td>
                        <td>{{ ordem.cliente.nome }}</td>
                        <td>{{ ordem.veiculo.marca }} {{ ordem.veiculo.modelo }}</td>
                        <td>{{ ordem.descricao_problema|truncatewords:5 }}</td>
                        <td>{{ ordem.data_entrada|date:"d/m/Y" }}</td>
                        <td>{{ ordem.data_previsao|date:"d/m/Y" }}</td>
                        <td>
                            <select class="status-select" data-ordem-id="{{ ordem.pk }}" onchange="alterarStatus(this)">
                                <option value="em_andamento" {% if ordem.status == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                                <option value="aguardando_pecas" {% if ordem.status == 'aguardando_pecas' %}selected{% endif %}>Aguardando Peças</option>
                                <option value="aguardando_aprovacao" {% if ordem.status == 'aguardando_aprovacao' %}selected{% endif %}>Aguardando Aprovação</option>
                                <option value="concluida" {% if ordem.status == 'concluida' %}selected{% endif %}>Concluída</option>
                                <option value="entregue" {% if ordem.status == 'entregue' %}selected{% endif %}>Entregue</option>
                                <option value="cancelada" {% if ordem.status == 'cancelada' %}selected{% endif %}>Cancelada</option>
                            </select>
                        </td>
                        <td>R$ {{ ordem.valor_final|floatformat:2 }}</td>
                        <td>
                            <a href="{% url 'ordem_visualizar' ordem.pk %}" class="btn-icon" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{% url 'ordem_editar' ordem.pk %}" class="btn-icon" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" style="text-align: center;">Nenhuma ordem de serviço encontrada</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function alterarStatus(selectElement) {
    const ordemId = selectElement.getAttribute('data-ordem-id');
    const novoStatus = selectElement.value;
    const originalStatus = selectElement.getAttribute('data-original-status') || selectElement.value;
    
    // Salvar status original para rollback em caso de erro
    selectElement.setAttribute('data-original-status', originalStatus);
    
    fetch(`/api/alterar-status-ordem/${ordemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `status=${novoStatus}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar o status original para o novo
            selectElement.setAttribute('data-original-status', novoStatus);
            
            // Adicionar feedback visual
            selectElement.style.borderColor = '#27ae60';
            setTimeout(() => {
                selectElement.style.borderColor = '';
            }, 1000);
        } else {
            alert('Erro ao alterar status: ' + data.error);
            selectElement.value = originalStatus;
        }
    })
    .catch(error => {
        alert('Erro ao alterar status');
        selectElement.value = originalStatus;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.status-select {
    padding: 0.4rem 0.8rem;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    background: white;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 180px;
}

.status-select:hover {
    border-color: #3498db;
}

.status-select:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.status-select option {
    padding: 0.5rem;
}
</style>

{% endblock %}
